name: Deploy backend to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: SSH and deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            trap 'echo "âŒ Error durante el despliegue del backend"; exit 1' ERR

            cd /root/app-presentacion/proyecto-ua-back

            echo "ğŸ“¦ Actualizando backend..."

            echo "ğŸ›¡ Protegiendo prisma/migrations/ localmente..."
            echo "prisma/migrations/" >> .git/info/exclude || true

            (pm2 describe backend >/dev/null 2>&1 && pm2 stop backend && pm2 delete backend) || echo "âš ï¸ backend no estaba corriendo"

            echo "ğŸ“¥ Haciendo pull sin sobrescribir prisma/migrations..."
            git reset --hard HEAD
            git pull

            echo "ğŸ”„ Regenerando cliente Prisma..."
            npx prisma generate

            echo "ğŸ›  Compilando backend..."
            npm install
            npm run build

            echo "ğŸŒ± Insertando datos semilla..."
            npm run seed

            pm2 start dist/src/main.js --name backend
            pm2 save

            echo "âœ… Backend actualizado correctamente sin tocar las migraciones locales"
